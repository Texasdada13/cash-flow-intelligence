{% extends "base.html" %}

{% block title %}AI Consultant - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        min-height: 500px;
    }

    .chat-messages {
        height: calc(100% - 120px);
        overflow-y: auto;
    }

    .chat-input-area {
        border-top: 1px solid #e9ecef;
        padding: 1rem;
        background: white;
    }

    .typing-indicator {
        display: none;
    }

    .typing-indicator.active {
        display: block;
    }

    .typing-indicator span {
        height: 8px;
        width: 8px;
        float: left;
        margin: 0 2px;
        background-color: #9e9ea1;
        display: block;
        border-radius: 50%;
        opacity: 0.4;
        animation: typing 1s infinite;
    }

    .typing-indicator span:nth-of-type(1) { animation-delay: 0.0s; }
    .typing-indicator span:nth-of-type(2) { animation-delay: 0.15s; }
    .typing-indicator span:nth-of-type(3) { animation-delay: 0.3s; }

    @keyframes typing {
        0% { transform: translateY(0px); opacity: 0.4; }
        50% { transform: translateY(-5px); opacity: 0.8; }
        100% { transform: translateY(0px); opacity: 0.4; }
    }

    .chat-message pre {
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 8px;
        overflow-x: auto;
    }

    .chat-message code {
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-building me-2"></i>Company
                </div>
                <div class="card-body p-2">
                    <select class="form-select" id="companySelect" onchange="changeCompany()">
                        <option value="">General Inquiry</option>
                        {% for c in companies %}
                        <option value="{{ c.id }}" {% if company and c.id == company.id %}selected{% endif %}>
                            {{ c.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            {% if company %}
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-heart-pulse me-2"></i>Financial Summary
                </div>
                <div class="card-body">
                    {% if company.health_score %}
                    <div class="text-center mb-3">
                        <div class="health-score {{ 'score-excellent' if company.health_score >= 80 else 'score-good' if company.health_score >= 70 else 'score-fair' if company.health_score >= 60 else 'score-poor' if company.health_score >= 40 else 'score-critical' }}">
                            {{ "%.0f"|format(company.health_score) }}
                        </div>
                        <small class="text-muted">Health Score</small>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fw-bold">{{ company.risk_level or 'N/A' }}</div>
                            <small class="text-muted">Risk Level</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold">{{ "%.1f"|format(company.cash_runway_months) if company.cash_runway_months else 'N/A' }}</div>
                            <small class="text-muted">Runway (mo)</small>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">No financial data yet</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-lightbulb me-2"></i>Suggested Prompts
                </div>
                <div class="card-body p-2" id="suggestedPrompts">
                    <div class="list-group list-group-flush">
                        <button class="list-group-item list-group-item-action suggested-prompt" onclick="usePrompt(this)">
                            How healthy is my cash flow right now?
                        </button>
                        <button class="list-group-item list-group-item-action suggested-prompt" onclick="usePrompt(this)">
                            What's our biggest cash flow risk?
                        </button>
                        <button class="list-group-item list-group-item-action suggested-prompt" onclick="usePrompt(this)">
                            How can we improve collections?
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-9">
            <div class="card chat-container">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-chat-dots me-2"></i>
                        AI CFO Consultant
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="newSession()">
                        <i class="bi bi-plus-circle me-1"></i>New Chat
                    </button>
                </div>

                <!-- Messages -->
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message assistant">
                        <strong>AI Consultant</strong>
                        <p class="mb-0 mt-1">
                            Hello! I'm your AI-powered CFO consultant. I can help you understand your cash flow,
                            analyze financial trends, and provide actionable recommendations.
                            {% if company %}
                            I have access to {{ company.name }}'s financial data. What would you like to discuss?
                            {% else %}
                            Select a company from the sidebar to get personalized insights, or ask me general
                            questions about cash flow management.
                            {% endif %}
                        </p>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="px-3 py-2 typing-indicator" id="typingIndicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>

                <!-- Input Area -->
                <div class="chat-input-area">
                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               id="chatInput"
                               placeholder="Ask me about cash flow, forecasting, benchmarks..."
                               onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" type="button" onclick="sendMessage()">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let sessionId = null;
const companyId = '{{ company.id if company else "" }}';

// Initialize session on page load
document.addEventListener('DOMContentLoaded', async function() {
    await createSession();
});

async function createSession() {
    try {
        const result = await apiCall('/api/chat/session', 'POST', {
            company_id: companyId || null
        });
        sessionId = result.session_id;
        updateSuggestedPrompts(result.suggested_prompts);
    } catch (error) {
        console.error('Failed to create session:', error);
    }
}

async function newSession() {
    document.getElementById('chatMessages').innerHTML = '';
    await createSession();

    // Add welcome message
    addMessage('assistant', `Hello! I'm your AI-powered CFO consultant. What would you like to discuss?`);
}

function changeCompany() {
    const companyId = document.getElementById('companySelect').value;
    if (companyId) {
        window.location.href = '/chat/' + companyId;
    } else {
        window.location.href = '/chat';
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();

    if (!message || !sessionId) return;

    // Add user message to UI
    addMessage('user', message);
    input.value = '';

    // Show typing indicator
    document.getElementById('typingIndicator').classList.add('active');

    try {
        // Stream response
        const response = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: sessionId,
                message: message
            })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        let assistantMessage = '';
        const messageDiv = addMessage('assistant', '', true);

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));

                        if (data.type === 'token') {
                            assistantMessage += data.content;
                            messageDiv.querySelector('.message-content').innerHTML = formatMessage(assistantMessage);
                        } else if (data.type === 'done') {
                            updateSuggestedPrompts(data.suggested_prompts);
                        } else if (data.type === 'error') {
                            messageDiv.querySelector('.message-content').innerHTML = `<span class="text-danger">${data.content}</span>`;
                        }
                    } catch (e) {
                        // Skip invalid JSON
                    }
                }
            }
        }
    } catch (error) {
        addMessage('assistant', `Sorry, I encountered an error: ${error.message}`);
    } finally {
        document.getElementById('typingIndicator').classList.remove('active');
        scrollToBottom();
    }
}

function addMessage(role, content, streaming = false) {
    const container = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = `chat-message ${role}`;

    if (role === 'user') {
        div.innerHTML = `<p class="mb-0">${escapeHtml(content)}</p>`;
    } else {
        div.innerHTML = `
            <strong>AI Consultant</strong>
            <div class="message-content mt-1">${streaming ? '' : formatMessage(content)}</div>
        `;
    }

    container.appendChild(div);
    scrollToBottom();

    return div;
}

function formatMessage(content) {
    // Basic markdown-like formatting
    content = escapeHtml(content);
    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
    content = content.replace(/`(.*?)`/g, '<code>$1</code>');
    content = content.replace(/\n/g, '<br>');
    return content;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function scrollToBottom() {
    const container = document.getElementById('chatMessages');
    container.scrollTop = container.scrollHeight;
}

function usePrompt(button) {
    document.getElementById('chatInput').value = button.textContent.trim();
    sendMessage();
}

function updateSuggestedPrompts(prompts) {
    if (!prompts || !prompts.length) return;

    const container = document.getElementById('suggestedPrompts');
    container.innerHTML = '<div class="list-group list-group-flush">' +
        prompts.map(p => `<button class="list-group-item list-group-item-action suggested-prompt" onclick="usePrompt(this)">${escapeHtml(p)}</button>`).join('') +
        '</div>';
}
</script>
{% endblock %}
